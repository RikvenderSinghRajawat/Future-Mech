{% extends "base.html" %}

{% block title %}Service Dashboard - Future Mech{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard_service.css') }}">
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Sidebar -->
    <nav class="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <i class="fas fa-car-side"></i>
                <span>Future Mech</span>
            </div>
            <div class="service-person-info">
                <div class="service-avatar">
                    <i class="fas fa-user-cog"></i>
                </div>
                <div class="service-details">
                    <h6>{{ session.username }}</h6>
                    <span class="role-badge">Service Person</span>
                </div>
            </div>
        </div>
        
        <ul class="sidebar-menu">
            <li class="menu-item active" data-section="overview">
                <a href="#" class="menu-link">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Overview</span>
                </a>
            </li>
            <li class="menu-item" data-section="assigned-jobs">
                <a href="#" class="menu-link">
                    <i class="fas fa-tasks"></i>
                    <span>Assigned Jobs</span>
                </a>
            </li>
            <li class="menu-item" data-section="completed-jobs">
                <a href="#" class="menu-link">
                    <i class="fas fa-check-circle"></i>
                    <span>Completed Jobs</span>
                </a>
            </li>
            <li class="menu-item" data-section="reports">
                <a href="#" class="menu-link">
                    <i class="fas fa-file-alt"></i>
                    <span>Reports</span>
                </a>
            </li>
            <li class="menu-item" data-section="profile">
                <a href="#" class="menu-link">
                    <i class="fas fa-user"></i>
                    <span>Profile</span>
                </a>
            </li>
        </ul>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Header -->
        <header class="dashboard-header">
            <div class="header-left">
                <button class="sidebar-toggle">
                    <i class="fas fa-bars"></i>
                </button>
                <h1 class="page-title">Service Dashboard</h1>
            </div>
            <div class="header-right">
                <div class="notifications">
                    <button class="notification-btn">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge">2</span>
                    </button>
                </div>
                <div class="user-menu">
                    <button class="user-btn">
                        <i class="fas fa-user-circle"></i>
                        <span>{{ session.username }}</span>
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="user-dropdown">
                        <a href="#" class="dropdown-item">
                            <i class="fas fa-user"></i>
                            Profile
                        </a>
                        <a href="#" class="dropdown-item">
                            <i class="fas fa-cog"></i>
                            Settings
                        </a>
                        <hr>
                        <a href="{{ url_for('logout') }}" class="dropdown-item">
                            <i class="fas fa-sign-out-alt"></i>
                            Logout
                        </a>
                    </div>
                </div>
            </div>
        </header>

        <!-- Dashboard Content -->
        <div class="dashboard-content">
            <!-- Overview Section -->
            <section id="overview-section" class="dashboard-section active">
                <div class="section-header">
                    <h2>Service Overview</h2>
                    <p>Welcome back! Here's your work summary for today.</p>
                </div>

                <!-- Stats Cards -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-content">
                            <h3>{{ today_pending }}</h3>
                            <p>Pending Today</p>
                            <span class="stat-change neutral">Ready to start</span>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-content">
                            <h3>{{ today_completed }}</h3>
                            <p>Completed Today</p>
                            <span class="stat-change positive">Great work!</span>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-calendar-week"></i>
                        </div>
                        <div class="stat-content">
                            <h3>{{ bookings|length }}</h3>
                            <p>Total Assigned</p>
                            <span class="stat-change neutral">All time</span>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-star"></i>
                        </div>
                        <div class="stat-content">
                            <h3>4.8</h3>
                            <p>Average Rating</p>
                            <span class="stat-change positive">Excellent!</span>
                        </div>
                    </div>
                </div>

                <!-- Today's Schedule -->
                <div class="today-schedule">
                    <h3>Today's Schedule</h3>
                    <div class="schedule-list">
                        {% for booking in bookings %}
                        {% if booking.scheduled_date.date() == today %}
                        <div class="schedule-item">
                            <div class="schedule-time">
                                <span class="time">{{ booking.scheduled_date.strftime('%I:%M %p') }}</span>
                            </div>
                            <div class="schedule-details">
                                <h5>{{ booking.service_name }}</h5>
                                <p><strong>Client:</strong> {{ booking.client_name }}</p>
                                <p><strong>Vehicle:</strong> {{ booking.registration_no or 'N/A' }} - {{ booking.model or 'N/A' }}</p>
                                <p><strong>Phone:</strong> {{ booking.phone or 'N/A' }}</p>
                            </div>
                            <div class="schedule-status">
                                <span class="status-badge {{ booking.status }}">{{ booking.status.replace('_', ' ').title() }}</span>
                                <div class="schedule-actions">
                                    <button class="btn btn-sm btn-primary" onclick="startJob({{ booking.id }})">
                                        <i class="fas fa-play"></i>
                                        Start
                                    </button>
                                    <button class="btn btn-sm btn-outline-primary" onclick="viewJobDetails({{ booking.id }})">
                                        <i class="fas fa-eye"></i>
                                        View
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </section>

            <!-- Assigned Jobs Section -->
            <section id="assigned-jobs-section" class="dashboard-section">
                <div class="section-header">
                    <h2>Assigned Jobs</h2>
                    <div class="header-actions">
                        <select id="status-filter" class="form-select">
                            <option value="">All Status</option>
                            <option value="pending">Pending</option>
                            <option value="confirmed">Confirmed</option>
                            <option value="in_progress">In Progress</option>
                        </select>
                    </div>
                </div>

                <div class="jobs-grid" id="assigned-jobs-grid">
                    {% for booking in bookings %}
                    {% if booking.status in ['pending', 'confirmed', 'in_progress'] %}
                    <div class="job-card" data-status="{{ booking.status }}">
                        <div class="job-header">
                            <div class="job-info">
                                <h4>{{ booking.service_name }}</h4>
                                <span class="status-badge {{ booking.status }}">{{ booking.status.replace('_', ' ').title() }}</span>
                            </div>
                            <div class="job-priority">
                                <i class="fas fa-flag"></i>
                            </div>
                        </div>
                        
                        <div class="job-body">
                            <div class="job-details">
                                <div class="detail-item">
                                    <i class="fas fa-user"></i>
                                    <span>{{ booking.client_name }}</span>
                                </div>
                                <div class="detail-item">
                                    <i class="fas fa-car"></i>
                                    <span>{{ booking.registration_no or 'N/A' }} - {{ booking.model or 'N/A' }}</span>
                                </div>
                                <div class="detail-item">
                                    <i class="fas fa-phone"></i>
                                    <span>{{ booking.phone or 'N/A' }}</span>
                                </div>
                                <div class="detail-item">
                                    <i class="fas fa-calendar"></i>
                                    <span>{{ booking.scheduled_date.strftime('%B %d, %Y at %I:%M %p') }}</span>
                                </div>
                            </div>
                            
                            {% if booking.remarks %}
                            <div class="job-remarks">
                                <h6>Special Instructions:</h6>
                                <p>{{ booking.remarks }}</p>
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="job-footer">
                            <div class="job-actions">
                                {% if booking.status == 'pending' or booking.status == 'confirmed' %}
                                <button class="btn btn-primary" onclick="startJob({{ booking.id }})">
                                    <i class="fas fa-play"></i>
                                    Start Job
                                </button>
                                {% elif booking.status == 'in_progress' %}
                                <button class="btn btn-success" onclick="completeJob({{ booking.id }})">
                                    <i class="fas fa-check"></i>
                                    Complete
                                </button>
                                {% endif %}
                                <button class="btn btn-outline-primary" onclick="viewJobDetails({{ booking.id }})">
                                    <i class="fas fa-eye"></i>
                                    Details
                                </button>
                                <button class="btn btn-outline-secondary" onclick="addInspectionReport({{ booking.id }})">
                                    <i class="fas fa-clipboard-check"></i>
                                    Inspection
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
            </section>

            <!-- Completed Jobs Section -->
            <section id="completed-jobs-section" class="dashboard-section">
                <div class="section-header">
                    <h2>Completed Jobs</h2>
                    <div class="header-actions">
                        <input type="date" id="completed-date-filter" class="form-control">
                    </div>
                </div>

                <div class="completed-jobs-list" id="completed-jobs-list">
                    {% for booking in bookings %}
                    {% if booking.status == 'completed' %}
                    <div class="completed-job-item">
                        <div class="job-summary">
                            <div class="job-info">
                                <h5>{{ booking.service_name }}</h5>
                                <p><strong>Client:</strong> {{ booking.client_name }}</p>
                                <p><strong>Vehicle:</strong> {{ booking.registration_no or 'N/A' }} - {{ booking.model or 'N/A' }}</p>
                            </div>
                            <div class="job-meta">
                                <span class="completion-date">{{ booking.completed_at.strftime('%B %d, %Y') if booking.completed_at else 'N/A' }}</span>
                                <span class="status-badge completed">Completed</span>
                            </div>
                        </div>
                        <div class="job-actions">
                            <button class="btn btn-outline-primary" onclick="viewJobDetails({{ booking.id }})">
                                <i class="fas fa-eye"></i>
                                View Details
                            </button>
                            <button class="btn btn-outline-secondary" onclick="generateReport({{ booking.id }})">
                                <i class="fas fa-file-alt"></i>
                                Generate Report
                            </button>
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
            </section>

            <!-- Reports Section -->
            <section id="reports-section" class="dashboard-section">
                <div class="section-header">
                    <h2>Reports & Documentation</h2>
                    <div class="header-actions">
                        <button class="btn btn-primary" onclick="generateAllReports()">
                            <i class="fas fa-file-alt"></i>
                            Generate All Reports
                        </button>
                    </div>
                </div>

                <div class="reports-grid">
                    <div class="report-card">
                        <div class="report-icon">
                            <i class="fas fa-chart-bar"></i>
                        </div>
                        <div class="report-content">
                            <h4>Performance Report</h4>
                            <p>Your service performance and statistics</p>
                            <button class="btn btn-outline-primary" onclick="generatePerformanceReport()">
                                Generate Report
                            </button>
                        </div>
                    </div>
                    
                    <div class="report-card">
                        <div class="report-icon">
                            <i class="fas fa-calendar-check"></i>
                        </div>
                        <div class="report-content">
                            <h4>Daily Summary</h4>
                            <p>Today's completed jobs and activities</p>
                            <button class="btn btn-outline-primary" onclick="generateDailySummary()">
                                Generate Report
                            </button>
                        </div>
                    </div>
                    
                    <div class="report-card">
                        <div class="report-icon">
                            <i class="fas fa-clipboard-list"></i>
                        </div>
                        <div class="report-content">
                            <h4>Inspection Reports</h4>
                            <p>Vehicle inspection and PDI reports</p>
                            <button class="btn btn-outline-primary" onclick="viewInspectionReports()">
                                View Reports
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Profile Section -->
            <section id="profile-section" class="dashboard-section">
                <div class="section-header">
                    <h2>Profile & Settings</h2>
                </div>

                <div class="profile-container">
                    <div class="profile-card">
                        <div class="profile-header">
                            <div class="profile-avatar">
                                <i class="fas fa-user-cog"></i>
                            </div>
                            <div class="profile-info">
                                <h4>{{ session.username }}</h4>
                                <p>Service Person</p>
                                <span class="status-badge active">Active</span>
                            </div>
                        </div>
                        
                        <div class="profile-details">
                            <div class="detail-group">
                                <label>Email:</label>
                                <span>service@futuremech.com</span>
                            </div>
                            <div class="detail-group">
                                <label>Phone:</label>
                                <span>+1 (555) 123-4567</span>
                            </div>
                            <div class="detail-group">
                                <label>Join Date:</label>
                                <span>January 15, 2024</span>
                            </div>
                            <div class="detail-group">
                                <label>Total Jobs:</label>
                                <span>{{ bookings|length }}</span>
                            </div>
                        </div>
                        
                        <div class="profile-actions">
                            <button class="btn btn-primary" onclick="editProfile()">
                                <i class="fas fa-edit"></i>
                                Edit Profile
                            </button>
                            <button class="btn btn-outline-primary" onclick="changePassword()">
                                <i class="fas fa-key"></i>
                                Change Password
                            </button>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>
</div>

<!-- Job Details Modal -->
<div class="modal fade" id="jobDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Job Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="job-details-content">
                <!-- Job details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="update-job-status">Update Status</button>
            </div>
        </div>
    </div>
</div>

<!-- Inspection Report Modal -->
<div class="modal fade" id="inspectionReportModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Inspection Report</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="inspectionReportForm">
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Overall Condition</label>
                            <select class="form-select" name="overall_condition" required>
                                <option value="">Select condition</option>
                                <option value="Excellent">Excellent</option>
                                <option value="Good">Good</option>
                                <option value="Fair">Fair</option>
                                <option value="Poor">Poor</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Health Score (0-100)</label>
                            <input type="number" class="form-control" name="health_score" min="0" max="100" required>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Issues Found</label>
                            <textarea class="form-control" name="issues" rows="3" placeholder="Describe any issues found during inspection"></textarea>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Recommendations</label>
                            <textarea class="form-control" name="recommendations" rows="3" placeholder="Provide recommendations for the customer"></textarea>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Next Service</label>
                            <input type="text" class="form-control" name="next_service" placeholder="e.g., After 5000 km or in 3 months">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Report</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/dashboard_service.js') }}"></script>
{% endblock %}





