{% extends "base.html" %}

{% block title %}Our Services - Future Mech{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/services.css') }}">
<style>
    .booking-options {
        display: flex;
        gap: 10px;
        margin-top: 15px;
    }
    .booking-option-btn {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 12px;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        background: white;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    .booking-option-btn:hover {
        border-color: #007bff;
        background-color: #f8f9fa;
    }
    .booking-option-btn.active {
        border-color: #007bff;
        background-color: #e7f1ff;
    }
    .booking-option-icon {
        font-size: 24px;
        margin-right: 10px;
        color: #6c757d;
    }
    .booking-option-btn.active .booking-option-icon {
        color: #007bff;
    }
    .vehicle-form-section {
        display: none;
        margin-top: 15px;
        padding: 15px;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        background-color: #f8f9fa;
    }
    .vehicle-form-section.active {
        display: block;
    }
    .call-now-info {
        text-align: center;
        padding: 20px;
        background-color: #f8f9fa;
        border-radius: 8px;
        margin-top: 15px;
    }
    .phone-number {
        font-size: 24px;
        font-weight: bold;
        color: #007bff;
        margin: 10px 0;
    }
    .service-hours {
        color: #6c757d;
        font-size: 14px;
    }
</style>
{% endblock %}

{% block content %}
<!-- Page Header -->
<section class="page-header">
    <div class="container">
        <div class="row">
            <div class="col-12 text-center">
                <div class="page-header-content">
                    <h1 class="display-3 fw-bold mb-4">Our Services</h1>
                    <p class="lead mb-0">Professional automotive services with cutting-edge technology</p>
                </div>
            </div>
        </div>
    </div>
</section>

<div class="container">
    <!-- Search and Filter Section -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="search-filter-container">
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" class="form-control" id="serviceSearch" placeholder="Search services...">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <select class="form-select" id="serviceTypeFilter">
                            <option value="">All Service Types</option>
                            {% for service_type in service_types %}
                                <option value="{{ service_type }}" {% if service_type == selected_type %}selected{% endif %}>
                                    {{ service_type }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-outline-primary w-100" id="clearFilters">
                            <i class="fas fa-times me-2"></i>Clear
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Services Grid -->
    <div class="row g-4" id="servicesGrid">
        {% for service in services %}
        <div class="col-lg-4 col-md-6 service-card-wrapper" data-service-type="{{ service.service_type or '' }}">
            <div class="service-card h-100">
                <div class="service-image">
                    <img src="{{ service.image_url or url_for('static', filename='images/service-placeholder.jpg') }}"
                         alt="{{ service.name }}" class="img-fluid">
                    <div class="service-badge">
                        <span class="badge bg-primary">{{ service.service_type or 'Service' }}</span>
                    </div>
                </div>
                <div class="service-content">
                    <h4 class="service-title">{{ service.name }}</h4>
                    <p class="service-description">{{ service.description }}</p>
                    <div class="service-details">
                        <div class="service-price">
                            <span class="price-currency">â‚¹</span>
                            <span class="price-amount">{{ "%.2f"|format(service.price) }}</span>
                        </div>
                        <div class="service-duration">
                            <i class="fas fa-clock me-1"></i>
                            {{ service.duration or '2-4 hours' }}
                        </div>
                    </div>
                    <div class="service-features">
                        <ul class="feature-list">
                            <li><i class="fas fa-check text-success me-2"></i>Professional Service</li>
                            <li><i class="fas fa-check text-success me-2"></i>Quality Guarantee</li>
                            <li><i class="fas fa-check text-success me-2"></i>Expert Technicians</li>
                        </ul>
                    </div>
                    <div class="service-actions">
                        {% if session.user_id %}
                            <button class="btn btn-primary w-100 book-service-btn" data-service-id="{{ service.id }}">
                                <i class="fas fa-calendar-alt me-2"></i>Book Now
                            </button>
                        {% else %}
                            <a href="{{ url_for('login') }}" class="btn btn-primary w-100">
                                <i class="fas fa-sign-in-alt me-2"></i>Login to Book
                            </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    
    <!-- No Results Message -->
    <div class="row" id="noResults" style="display: none;">
        <div class="col-12 text-center py-5">
            <div class="no-results">
                <i class="fas fa-search fa-3x text-muted mb-3"></i>
                <h4>No services found</h4>
                <p class="text-muted">Try adjusting your search criteria or browse all services.</p>
                <button class="btn btn-outline-primary" id="showAllServices">
                    <i class="fas fa-list me-2"></i>Show All Services
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Service Booking Modal -->
<div class="modal fade" id="bookingModal" tabindex="-1" aria-labelledby="bookingModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bookingModalLabel">Book Service</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="booking-options">
                    <div class="booking-option-btn active" id="onlineBookingOption">
                        <div class="booking-option-icon">
                            <i class="fas fa-calendar-alt"></i>
                        </div>
                        <div>
                            <div class="fw-bold">Book Online</div>
                            <small class="text-muted">Schedule your service</small>
                        </div>
                    </div>
                    <div class="booking-option-btn" id="callNowOption">
                        <div class="booking-option-icon">
                            <i class="fas fa-phone-alt"></i>
                        </div>
                        <div>
                            <div class="fw-bold">Call Now</div>
                            <small class="text-muted">Speak with our experts</small>
                        </div>
                    </div>
                </div>
                
                <!-- Online Booking Form -->
                <div id="onlineBookingForm">
                    <form id="bookingForm">
                        <input type="hidden" id="selectedServiceId" name="service_id">
                        
                        <div class="row g-3 mt-3">
                            <div class="col-md-6">
                                <label class="form-label">Vehicle Selection</label>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="radio" name="vehicleOption" id="existingVehicle" value="existing" checked>
                                    <label class="form-check-label" for="existingVehicle">
                                        Select from my vehicles
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="vehicleOption" id="newVehicle" value="new">
                                    <label class="form-check-label" for="newVehicle">
                                        Add new vehicle
                                    </label>
                                </div>
                                
                                <!-- Existing Vehicle Selection -->
                                <div class="vehicle-selection mt-3" id="existingVehicleSection">
                                    <select class="form-select" name="vehicle_id" id="vehicleSelect">
                                        <option value="">Choose your vehicle</option>
                                        <!-- Vehicle options will be populated via JavaScript -->
                                    </select>
                                </div>
                                
                                <!-- New Vehicle Form -->
                                <div class="vehicle-form-section" id="newVehicleFormSection">
                                    <div class="row g-2">
                                        <div class="col-12">
                                            <label class="form-label">Registration Number</label>
                                            <input type="text" class="form-control" name="registration_no" placeholder="e.g. ABC123">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Make</label>
                                            <input type="text" class="form-control" name="make" placeholder="e.g. Toyota">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Model</label>
                                            <input type="text" class="form-control" name="model" placeholder="e.g. Camry">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Year</label>
                                            <input type="number" class="form-control" name="year" placeholder="e.g. 2020" min="1990" max="2030">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Color</label>
                                            <input type="text" class="form-control" name="color" placeholder="e.g. Red">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Preferred Date & Time</label>
                                <input type="datetime-local" class="form-control" name="scheduled_date" required>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Special Instructions</label>
                                <textarea class="form-control" name="notes" rows="3" 
                                          placeholder="Any specific requirements or notes..."></textarea>
                            </div>
                        </div>
                    </form>
                </div>
                
                <!-- Call Now Information -->
                <div id="callNowInfo" class="call-now-info" style="display: none;">
                    <div class="call-now-icon mb-3">
                        <i class="fas fa-phone-alt fa-3x text-primary"></i>
                    </div>
                    <h4>Call Us Now</h4>
                    <p class="text-muted">Speak directly with our service experts to schedule your appointment</p>
                    <div class="phone-number">
                        <i class="fas fa-phone me-2"></i>+91 6378528881
                    </div>
                    <div class="service-hours mt-3">
                        <p><strong>Service Hours:</strong></p>
                        <p>Monday - Sunday: 8:00 AM - 6:00 PM</p>
                        <!-- <p>Saturday: 9:00 AM - 4:00 PM</p> -->
                        <!-- <p>Sunday: Closed</p> -->
                    </div>
                    <div class="mt-4">
                        <p class="text-muted">We'll help you find the best time for your service and answer any questions you have about our services.</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="callNowBtn" style="display: none;">
                    <i class="fas fa-phone me-2"></i>Call Now
                </button>
                <button type="button" class="btn btn-primary" id="confirmBooking">
                    <i class="fas fa-calendar-check me-2"></i>Confirm Booking
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/services.js') }}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Booking option toggle
        const onlineBookingOption = document.getElementById('onlineBookingOption');
        const callNowOption = document.getElementById('callNowOption');
        const onlineBookingForm = document.getElementById('onlineBookingForm');
        const callNowInfo = document.getElementById('callNowInfo');
        const confirmBookingBtn = document.getElementById('confirmBooking');
        const callNowBtn = document.getElementById('callNowBtn');
        
        onlineBookingOption.addEventListener('click', function() {
            setActiveOption('online');
        });
        
        callNowOption.addEventListener('click', function() {
            setActiveOption('call');
        });
        
        function setActiveOption(option) {
            if (option === 'online') {
                onlineBookingOption.classList.add('active');
                callNowOption.classList.remove('active');
                onlineBookingForm.style.display = 'block';
                callNowInfo.style.display = 'none';
                confirmBookingBtn.style.display = 'block';
                callNowBtn.style.display = 'none';
            } else {
                onlineBookingOption.classList.remove('active');
                callNowOption.classList.add('active');
                onlineBookingForm.style.display = 'none';
                callNowInfo.style.display = 'block';
                confirmBookingBtn.style.display = 'none';
                callNowBtn.style.display = 'block';
            }
        }
        
        // Call Now button functionality
        callNowBtn.addEventListener('click', function() {
            window.location.href = 'tel:+18001234567';
        });
        
        // Vehicle option toggle
        const existingVehicleRadio = document.getElementById('existingVehicle');
        const newVehicleRadio = document.getElementById('newVehicle');
        const existingVehicleSection = document.getElementById('existingVehicleSection');
        const newVehicleFormSection = document.getElementById('newVehicleFormSection');
        
        existingVehicleRadio.addEventListener('change', function() {
            if (this.checked) {
                existingVehicleSection.style.display = 'block';
                newVehicleFormSection.classList.remove('active');
            }
        });
        
        newVehicleRadio.addEventListener('change', function() {
            if (this.checked) {
                existingVehicleSection.style.display = 'none';
                newVehicleFormSection.classList.add('active');
            }
        });
        
        // Load user vehicles when modal is shown
        const bookingModal = document.getElementById('bookingModal');
        bookingModal.addEventListener('show.bs.modal', function() {
            loadUserVehicles();
        });
        
        function loadUserVehicles() {
            fetch('/api/client/vehicles')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const vehicleSelect = document.getElementById('vehicleSelect');
                        vehicleSelect.innerHTML = '<option value="">Choose your vehicle</option>';
                        
                        data.vehicles.forEach(vehicle => {
                            const option = document.createElement('option');
                            option.value = vehicle.id;
                            option.textContent = `${vehicle.make} ${vehicle.model} (${vehicle.registration_no})`;
                            vehicleSelect.appendChild(option);
                        });
                        
                        // If no vehicles, automatically select "Add new vehicle"
                        if (data.vehicles.length === 0) {
                            document.getElementById('newVehicle').checked = true;
                            existingVehicleSection.style.display = 'none';
                            newVehicleFormSection.classList.add('active');
                        }
                    }
                })
                .catch(error => {
                    console.error('Error loading vehicles:', error);
                });
        }
        
        // Confirm booking
        confirmBookingBtn.addEventListener('click', function() {
            const serviceId = document.getElementById('selectedServiceId').value;
            const scheduledDate = document.querySelector('input[name="scheduled_date"]').value;
            const notes = document.querySelector('textarea[name="notes"]').value;
            
            if (!scheduledDate) {
                alert('Please select a date and time for your service.');
                return;
            }
            
            let vehicleId = null;
            let newVehicleData = null;
            
            if (document.getElementById('existingVehicle').checked) {
                vehicleId = document.getElementById('vehicleSelect').value;
                if (!vehicleId) {
                    alert('Please select a vehicle.');
                    return;
                }
            } else {
                // Validate new vehicle form
                const registrationNo = document.querySelector('input[name="registration_no"]').value;
                const make = document.querySelector('input[name="make"]').value;
                const model = document.querySelector('input[name="model"]').value;
                const year = document.querySelector('input[name="year"]').value;
                
                if (!registrationNo || !make || !model || !year) {
                    alert('Please fill in all vehicle details.');
                    return;
                }
                
                newVehicleData = {
                    registration_no: registrationNo,
                    make: make,
                    model: model,
                    year: year,
                    color: document.querySelector('input[name="color"]').value || ''
                };
            }
            
            // First, add new vehicle if needed
            if (newVehicleData) {
                const formData = new FormData();
                for (const key in newVehicleData) {
                    formData.append(key, newVehicleData[key]);
                }
                
                fetch('/api/client/add_vehicle', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Now book the service with the new vehicle
                        bookService(serviceId, data.vehicle_id || null, scheduledDate, notes);
                    } else {
                        alert('Error adding vehicle: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error adding vehicle:', error);
                    alert('Error adding vehicle. Please try again.');
                });
            } else {
                // Book with existing vehicle
                bookService(serviceId, vehicleId, scheduledDate, notes);
            }
        });
        
        function bookService(serviceId, vehicleId, scheduledDate, notes) {
            const bookingData = {
                service_id: serviceId,
                vehicle_id: vehicleId,
                scheduled_date: scheduledDate,
                notes: notes
            };
            
            fetch(`/book_service/${serviceId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(bookingData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Booking created successfully!');
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('bookingModal'));
                    modal.hide();
                    // Redirect to payment or dashboard
                    if (data.booking_id) {
                        window.location.href = `/payment/booking/${data.booking_id}`;
                    } else {
                        window.location.href = '/dashboard';
                    }
                } else {
                    alert('Error creating booking: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error creating booking:', error);
                alert('Error creating booking. Please try again.');
            });
        }
    });
</script>
{% endblock %}